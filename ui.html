<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ask Nova</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #001E3F 0%, #000C1F 100%);
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: white;
    }
    
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px 24px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .logo {
      height: 30px;
      display: flex;
      align-items: center;
    }
    
    .header-title {
      font-size: 18px;
      font-weight: 600;
      color: white;
    }
    
    .knowledge-status {
      margin-left: auto;
      padding: 6px 12px;
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 16px;
      font-size: 12px;
      color: #4ade80;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .knowledge-icon {
      width: 12px;
      height: 12px;
      fill: currentColor;
    }
    
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .welcome-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px 24px;
    }
    
    .welcome-state.hidden {
      display: none;
    }
    
    .welcome-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: white;
    }
    
    .welcome-subtitle {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 32px;
    }
    
    .suggestion-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
      max-width: 320px;
    }
    
    .suggestion-btn {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      text-align: left;
      transition: all 0.2s ease;
    }
    
    .suggestion-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }
    
    .message {
      display: flex;
      margin-bottom: 16px;
    }
    
    .message.user {
      justify-content: flex-end;
    }
    
    .message.ai {
      justify-content: flex-start;
    }
    
    .message.system {
      justify-content: flex-start;
    }
    
    .message-bubble {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    
    .message.user .message-bubble {
      background: #003366;
      color: white;
      border-bottom-right-radius: 4px;
    }
    
    .message.ai .message-bubble {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-bottom-left-radius: 4px;
    }
    
    .message.system .message-bubble {
      background: rgba(0, 30, 63, 0.2);
      color: #7BB3F0;
      border: 1px solid rgba(0, 30, 63, 0.4);
      border-bottom-left-radius: 4px;
    }
    
    .loading-message {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      max-width: 85%;
    }
    
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .input-section {
      padding: 20px 24px 24px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .input-container {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    
    .message-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      font-size: 14px;
      resize: none;
      outline: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      min-height: 44px;
      max-height: 120px;
    }
    
    .message-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .message-input:focus {
      border-color: #4A90E2;
      box-shadow: 0 0 0 1px #4A90E2;
    }
    
    .send-btn {
      padding: 12px;
      background: #0077FF;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      transition: all 0.2s ease;
    }
    
    .send-btn:hover {
      background: #0066DD;
      transform: scale(1.05);
    }
    
    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .input-help {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 8px;
      text-align: center;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #001E3F 0%, #000C1F 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .loading-overlay.hidden {
      display: none;
    }
    
    .loading-text {
      margin-top: 16px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Scrollbar styling */
    .messages-container::-webkit-scrollbar {
      width: 4px;
    }
    
    .messages-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .messages-container::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
    }
    
    .messages-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
  </style>
</head>
<body>
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner" style="width: 32px; height: 32px; border-width: 3px;"></div>
    <div class="loading-text">Loading design system knowledge...</div>
  </div>

  <div class="header">
    <div class="logo">
      <svg width="138" height="30" viewBox="0 0 138 30" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M20.5454 23L26.7481 4.12788H32.3174L38.4409 23H33.9802L32.6869 18.8033H25.8507L24.5574 23H20.5454ZM29.282 7.61196L26.7745 15.7679H31.7631L29.282 7.61196ZM45.6922 23.2903C41.9706 23.2903 39.8062 21.6539 39.6742 18.6713H43.2375C43.3959 19.9118 44.0029 20.6245 45.6658 20.6245C47.1439 20.6245 47.8302 20.0702 47.8302 19.12C47.8302 18.1698 47.0119 17.7739 45.0323 17.4835C41.3635 16.9292 39.9382 15.8735 39.9382 13.1812C39.9382 10.3042 42.5776 8.8789 45.4019 8.8789C48.4636 8.8789 50.76 9.98747 51.1031 13.1548H47.5926C47.3814 12.0199 46.748 11.492 45.4282 11.492C44.1877 11.492 43.475 12.0726 43.475 12.9173C43.475 13.7883 44.1349 14.1314 46.1409 14.4218C49.5986 14.9233 51.499 15.7943 51.499 18.7505C51.499 21.7331 49.3346 23.2903 45.6922 23.2903ZM53.9261 23V2.94012H57.7533V15.0288L62.1876 9.19564H66.2523L61.2374 15.4775L66.6482 23H62.3195L57.7533 16.4805V23H53.9261ZM74.7611 23V4.12788H79.7233L86.9026 16.5597V4.12788H90.7034V23H86.4275L78.5619 9.56516V23H74.7611ZM100.731 20.3869C102.869 20.3869 104.11 18.8033 104.11 16.1902V16.0054C104.11 13.366 102.869 11.7823 100.731 11.7823C98.6199 11.7823 97.353 13.3132 97.353 15.9526V16.1638C97.353 18.8033 98.5671 20.3869 100.731 20.3869ZM100.705 23.2903C96.5875 23.2903 93.4466 20.5453 93.4466 16.243V16.0318C93.4466 11.7031 96.5875 8.8789 100.731 8.8789C104.875 8.8789 107.99 11.6503 107.99 15.9526V16.1638C107.99 20.5189 104.849 23.2903 100.705 23.2903ZM113.762 23L108.721 9.19564H112.812L116.111 19.0672L119.384 9.19564H123.079L118.064 23H113.762ZM128.48 23.2903C125.973 23.2903 123.861 22.0762 123.861 19.1728C123.861 15.9526 126.817 14.7385 131.04 14.7385H132.598V14.1842C132.598 12.5477 132.096 11.6503 130.354 11.6503C128.85 11.6503 128.163 12.4158 128.005 13.6035H124.389C124.626 10.3306 127.213 8.8789 130.592 8.8789C133.97 8.8789 136.372 10.2514 136.372 13.9994V23H132.65V21.3371C131.859 22.4457 130.644 23.2903 128.48 23.2903ZM129.615 20.6245C131.304 20.6245 132.598 19.7007 132.598 18.1698V17.0084H131.119C128.902 17.0084 127.609 17.4835 127.609 18.9616C127.609 19.9646 128.216 20.6245 129.615 20.6245Z" fill="white"/>
        <path d="M3.31997 11.7413L4.09067 14.7408C4.20924 14.9856 4.44638 15.1693 4.74281 15.1693C4.97995 15.1693 5.21709 14.9856 5.33566 14.7408L6.16565 11.7413L9.01134 10.9455C9.24848 10.823 9.48562 10.5782 9.48562 10.2721C9.48562 10.0273 9.24848 9.7824 9.01134 9.65997L6.16565 8.80296L5.33566 5.86466C5.21709 5.6198 4.97995 5.37494 4.74281 5.37494C4.44638 5.37494 4.20924 5.6198 4.09067 5.86466L3.31997 8.80296L0.414996 9.65997C0.177855 9.7824 0 10.0273 0 10.2721C0 10.5782 0.177855 10.823 0.414996 10.9455L3.31997 11.7413Z" fill="url(#paint0_linear_11_56)"/>
        <path d="M7.94421 19.638L10.197 20.3113L10.8492 22.6375C10.9085 22.8823 11.1456 23.0048 11.3827 23.0048C11.5606 23.0048 11.7977 22.8823 11.857 22.6375L12.5092 20.3113L14.762 19.638C14.9991 19.5767 15.177 19.3319 15.177 19.087C15.177 18.9034 14.9991 18.6585 14.762 18.5973L12.5092 17.924L11.857 15.5978C11.7977 15.3529 11.5606 15.1693 11.3827 15.1693C11.1456 15.1693 10.9085 15.3529 10.8492 15.5978L10.197 17.924L7.94421 18.5973C7.70707 18.6585 7.58849 18.9034 7.58849 19.087C7.58849 19.3319 7.70707 19.5767 7.94421 19.638Z" fill="url(#paint1_linear_11_56)"/>
        <defs>
          <linearGradient id="paint0_linear_11_56" x1="15.177" y1="14.2207" x2="-8.64715e-08" y2="14.2207" gradientUnits="userSpaceOnUse">
            <stop stop-color="#00DE96"/>
            <stop offset="1" stop-color="#008FF7"/>
          </linearGradient>
          <linearGradient id="paint1_linear_11_56" x1="15.177" y1="14.2207" x2="-8.64715e-08" y2="14.2207" gradientUnits="userSpaceOnUse">
            <stop stop-color="#00DE96"/>
            <stop offset="1" stop-color="#008FF7"/>
          </linearGradient>
        </defs>
      </svg>
    </div>
    
    <div class="knowledge-status">
      <svg class="knowledge-icon" viewBox="0 0 24 24">
        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <span>Knowledge Ready</span>
    </div>
  </div>

  <div id="messages-container" class="messages-container">
    <div id="welcome-state" class="welcome-state">
      <h2 class="welcome-title">Got a question? Just ask.</h2>
      <p class="welcome-subtitle">Search tokens, components, and guidelines directly in Figma — no context switching.</p>
      
      <div class="suggestion-buttons">
        <button class="suggestion-btn" data-suggestion="What colors should I use for error states?">What colors should I use for error states?</button>
        <button class="suggestion-btn" data-suggestion="Show me the button component guidelines">Show me the button component guidelines</button>
        <button class="suggestion-btn" data-suggestion="What's the spacing scale for margins?">What's the spacing scale for margins?</button>
        <button class="suggestion-btn" data-suggestion="How do I implement the typography hierarchy?">How do I implement the typography hierarchy?</button>
      </div>
    </div>
  </div>

  <div class="input-section">
    <div class="input-container">
      <textarea 
        id="message-input" 
        class="message-input" 
        placeholder="Ask about the Nova Design System..."
        rows="1"
      ></textarea>
      <button id="send-btn" class="send-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Load external knowledge base -->
  <script src="knowledge-base.js"></script>
  
  <script>
    let isLoading = false;
    let messages = [];

    // Get DOM elements
    const loadingOverlay = document.getElementById('loading-overlay');
    const messagesContainer = document.getElementById('messages-container');
    const welcomeState = document.getElementById('welcome-state');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    console.log('Ask Nova starting...');

    // Initialize the plugin
    function init() {
      console.log('Initializing Ask Nova...');
      
      // Check if knowledge base is loaded
      if (typeof window.DESIGN_SYSTEM_KNOWLEDGE === 'undefined') {
        console.error('Knowledge base not loaded!');
        document.querySelector('.knowledge-status span').textContent = 'Knowledge Error';
        document.querySelector('.knowledge-status').style.background = 'rgba(239, 68, 68, 0.2)';
        document.querySelector('.knowledge-status').style.borderColor = 'rgba(239, 68, 68, 0.3)';
        document.querySelector('.knowledge-status').style.color = '#f87171';
        return;
      }
      
      // Simulate loading the knowledge base
      setTimeout(() => {
        loadingOverlay.classList.add('hidden');
        console.log('Knowledge base loaded, length:', window.DESIGN_SYSTEM_KNOWLEDGE.length);
      }, 1500);
      
      // Send button and input handlers
      if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
      }
      
      if (messageInput) {
        messageInput.addEventListener('keydown', handleKeyPress);
        messageInput.addEventListener('input', autoResizeTextarea);
      }
      
      // Suggestion button handlers
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('suggestion-btn')) {
          const suggestion = e.target.getAttribute('data-suggestion');
          if (messageInput && suggestion) {
            messageInput.value = suggestion;
            messageInput.focus();
            autoResizeTextarea();
          }
        }
      });
      
      console.log('All event listeners initialized');
    }

    async function sendMessage() {
      const message = messageInput.value.trim();
      
      if (!message) {
        console.log('No message to send');
        return;
      }
      
      if (typeof window.DESIGN_SYSTEM_KNOWLEDGE === 'undefined') {
        addMessage('ai', '❌ Knowledge base not loaded. Please refresh the plugin.');
        return;
      }
      
      if (isLoading) {
        console.log('Already loading, ignoring send request');
        return;
      }

      console.log('Sending message:', message);
      
      addMessage('user', message);
      messageInput.value = '';
      autoResizeTextarea();
      
      showLoading();
      isLoading = true;
      sendBtn.disabled = true;

      try {
        console.log('Processing question with local knowledge base...');
        
        // Find relevant sections in the knowledge base
        let relevantText = window.DESIGN_SYSTEM_KNOWLEDGE;
        const questionLower = message.toLowerCase();
        
        // If the knowledge base is very long, try to find relevant sections
        if (window.DESIGN_SYSTEM_KNOWLEDGE.length > 15000) {
          console.log('Knowledge base is large, finding relevant sections...');
          const textLower = window.DESIGN_SYSTEM_KNOWLEDGE.toLowerCase();
          
          // Keywords to search for
          const keywords = ['color', 'typography', 'font', 'button', 'spacing', 'margin', 'padding', 'grid', 'component', 'layout', 'style'];
          let bestMatch = '';
          let foundKeyword = '';
          
          for (const keyword of keywords) {
            if (questionLower.includes(keyword)) {
              const index = textLower.indexOf(keyword);
              if (index !== -1) {
                const start = Math.max(0, index - 3000);
                const end = Math.min(window.DESIGN_SYSTEM_KNOWLEDGE.length, index + 8000);
                bestMatch = window.DESIGN_SYSTEM_KNOWLEDGE.substring(start, end);
                foundKeyword = keyword;
                console.log(`Found relevant section for keyword "${keyword}"`);
                break;
              }
            }
          }
          
          if (bestMatch) {
            relevantText = bestMatch;
            console.log(`Using relevant section (${relevantText.length} chars) for keyword "${foundKeyword}"`);
          } else {
            // If no specific match, take beginning of document
            relevantText = window.DESIGN_SYSTEM_KNOWLEDGE.substring(0, 15000);
            console.log('No specific match found, using first 15000 characters');
          }
        }
        
        // Generate a contextual response based on the knowledge
        const response = generateResponse(message, relevantText);
        
        hideLoading();
        addMessage('ai', response);
        
      } catch (error) {
        console.error('Error processing message:', error);
        hideLoading();
        
        const errorMessage = '❌ Sorry, I encountered an error processing your question. Please try again.';
        addMessage('ai', errorMessage);
        
      } finally {
        isLoading = false;
        sendBtn.disabled = false;
        console.log('Message processing completed');
      }
    }

    function generateResponse(question, knowledgeBase) {
      // Simple response generation based on keywords
      const questionLower = question.toLowerCase();
      const lines = knowledgeBase.split('\n').filter(line => line.trim());
      
      // Look for relevant sections
      let relevantSections = [];
      
      // Common design system topics
      const topics = {
        'color': ['color', 'palette', 'primary', 'secondary', 'rgb', 'hex', 'blue', 'red', 'green'],
        'typography': ['font', 'text', 'heading', 'body', 'weight', 'size', 'typography'],
        'spacing': ['spacing', 'margin', 'padding', 'gap', 'px', 'rem'],
        'button': ['button', 'cta', 'primary', 'secondary', 'action'],
        'component': ['component', 'element', 'widget', 'module'],
        'grid': ['grid', 'layout', 'column', 'row', 'container'],
        'accessibility': ['accessibility', 'a11y', 'contrast', 'screen reader'],
        'form': ['input', 'form', 'field', 'label'],
        'modal': ['modal', 'dialog', 'popup', 'overlay'],
        'navigation': ['nav', 'menu', 'header', 'sidebar'],
        'table': ['table', 'row', 'column', 'cell'],
        'icon': ['icon', 'iconography', 'symbol'],
        'animation': ['animation', 'transition', 'motion', 'hover']
      };
      
      // Find which topic the question is about
      let mainTopic = 'general';
      for (const [topic, keywords] of Object.entries(topics)) {
        if (keywords.some(keyword => questionLower.includes(keyword))) {
          mainTopic = topic;
          break;
        }
      }
      
      // Find relevant lines in knowledge base
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].toLowerCase();
        const keywords = topics[mainTopic] || [];
        
        if (keywords.some(keyword => line.includes(keyword)) || 
            questionLower.split(' ').some(word => word.length > 2 && line.includes(word))) {
          
          // Include this line and some context
          let section = lines[i];
          let j = i + 1;
          
          // Add following lines that seem related
          while (j < lines.length && j < i + 8) {
            if (lines[j].trim() && !lines[j].trim().match(/^[A-Z\s]+:$/)) {
              section += '\n' + lines[j];
            } else if (lines[j].trim().match(/^[A-Z\s]+:$/)) {
              break;
            }
            j++;
          }
          
          relevantSections.push(section);
          i = j - 1; // Skip ahead
        }
      }
      
      // Generate response
      if (relevantSections.length === 0) {
        return `I don't see specific information about "${question}" in the design system documentation. 

Here are some topics I can help with based on the available documentation:
• Color guidelines and palettes
• Typography rules and scales  
• Component specifications (buttons, forms, cards, modals)
• Spacing and layout guidelines
• Grid system details
• Accessibility requirements
• Navigation patterns
• Animation guidelines

Try asking a more specific question about one of these areas.`;
      }
      
      let response = `Based on the design system documentation, here's what I found about ${mainTopic === 'general' ? 'your question' : mainTopic}:\n\n`;
      
      relevantSections.forEach((section, index) => {
        if (index > 0) response += '\n\n';
        response += section.trim();
      });
      
      response += '\n\nIs there anything specific about this you\'d like me to clarify or expand on?';
      
      return response;
    }

    function addMessage(type, content) {
      messages.push({ type, content });
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const bubbleDiv = document.createElement('div');
      bubbleDiv.className = 'message-bubble';
      bubbleDiv.textContent = content;
      
      messageDiv.appendChild(bubbleDiv);
      messagesContainer.appendChild(messageDiv);
      
      if (welcomeState) {
        welcomeState.classList.add('hidden');
      }
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showLoading() {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loading-indicator';
      loadingDiv.className = 'message ai';
      loadingDiv.innerHTML = '<div class="loading-message"><div class="spinner"></div><span>Thinking...</span></div>';
      messagesContainer.appendChild(loadingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideLoading() {
      const loadingDiv = document.getElementById('loading-indicator');
      if (loadingDiv) {
        loadingDiv.remove();
      }
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function autoResizeTextarea() {
      if (messageInput) {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    console.log('Ask Nova loaded successfully');
  </script>
</body>
</html>